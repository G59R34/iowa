<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Tesla Supercharger - Study Level</title>
    <link rel="stylesheet" href="elite-tesla.css">
    <script src="global-nav.js"></script>
</head>
<body>
    <!-- Spinning Cat GIF -->
    <div class="spinning-cat">
        <img src="spinningcat.gif" alt="Spinning Cat" class="cat-gif">
    </div>

    <!-- Math Challenge Section -->
    <div class="math-challenge">
        <h2>üßÆ Elite Access Math Challenge</h2>
        <div class="equation-display">
            <p class="equation-text">Solve: ‚à´(3x¬≤ + 2x - 5)dx from 0 to 4 = 6+8butdumb</p>
            <div class="answer-section">
                <input type="number" id="math-answer" class="answer-input" placeholder="Enter answer">
                <button class="submit-btn" onclick="checkAnswer()">Submit Answer</button>
            </div>
            <div class="answer-feedback" id="answer-feedback"></div>
        </div>
        
        <!-- Hidden Elite Access Button -->
        <div class="elite-access" id="elite-access" style="display: none;">
            <button class="elite-btn" onclick="showEliteSection()">üèÜ Access Elite Supercharger</button>
        </div>
    </div>

    <!-- Elite Tesla Supercharger Section (Hidden until math is solved) -->
    <div id="elite-section" class="elite-supercharger hidden-section">
        <header class="elite-header">
            <h1>üî• ELITE TESLA SUPERCHARGER üî•</h1>
            <p class="elite-subtitle">Study Level - Ultra Premium Experience</p>
        </header>

        <div class="game-container">
            <!-- Left Section: Tesla and Parking -->
            <div class="left-section">
                <div class="tesla-container">
                    <h3>üöó Tesla Model S</h3>
                    <div class="tesla-placeholder draggable-tesla" draggable="true" id="tesla-car">
                        <img src="tesla-model-s.png" alt="Tesla Model S" class="tesla-image">
                        <div class="tesla-fallback">üöó</div>
                    </div>
                    <p class="instruction-text">Drag to parking space</p>
                </div>
                
                <div class="parking-lot">
                    <h3>üÖøÔ∏è Parking Space</h3>
                    <div class="parking-space" id="parking-target">
                        <div class="parking-lines"></div>
                        <div class="drop-instruction">Drop Tesla Here</div>
                    </div>
                </div>
            </div>
            
            <!-- Center Section: Supercharger Station -->
            <div class="center-section">
                <div class="supercharger-station">
                    <h3>‚ö° Supercharger Station</h3>
                    <div class="station-placeholder">
                        <img src="supercharger-station.png" alt="Tesla Supercharger Station" class="station-image">
                        <div class="station-fallback">‚ö°</div>
                    </div>
                    
                    <div class="charging-handle-container">
                        <div class="charging-cable draggable-handle" draggable="true" id="charging-handle">
                            <img src="supercharger-handle.png" alt="Supercharger Handle" class="handle-image">
                            <div class="handle-fallback">üîå</div>
                        </div>
                        <p class="instruction-text">Drag to parked Tesla</p>
                    </div>
                    
                    <div class="car-connection-zone" id="connection-target">
                        <div class="connection-instruction">Connection Zone</div>
                    </div>
                    
                    <div class="charging-display">
                        <div class="power-meter">
                            <div class="meter-label">Power Output</div>
                            <div class="meter-bar">
                                <div class="power-level"></div>
                            </div>
                            <div class="power-text">250 kW</div>
                        </div>
                        
                        <div class="battery-status">
                            <div class="battery-visual">
                                <div class="battery-fill"></div>
                            </div>
                            <div class="battery-percent">32%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Section: Phone -->
            <div class="right-section">
                <div class="fake-phone">
                    <div class="phone-screen">
                        <div class="phone-header">
                            <div class="phone-time">2:47 PM</div>
                            <div class="phone-battery">üîã 89%</div>
                        </div>
                        
                        <div class="banking-app">
                            <h3>üí≥ Tesla Bank</h3>
                            <div class="account-balance">
                                <div class="balance-label">Checking Account</div>
                                <div class="balance-amount">$50,000.00</div>
                            </div>
                            
                            <div class="transaction-feed">
                                <div class="transaction">
                                    <span class="transaction-desc">Supercharging Session</span>
                                    <span class="transaction-amount">-$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charging-cost">
                            <div class="cost-per-minute">$2.50/min</div>
                            <div class="total-cost">Total: $0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charging Controls -->
        <div class="elite-controls">
            <button class="charge-button" id="charge-button" disabled>
                <span class="charge-text">Complete Setup First</span>
            </button>
            
            <button class="unpark-button" id="unpark-button" onclick="unparkCar()">
                <span class="unpark-text">üöó Unpark Tesla</span>
            </button>
            
            <div class="setup-status">
                <div class="status-item" id="parking-status">
                    <span class="status-icon">‚≠ï</span>
                    <span class="status-text">Park Tesla</span>
                </div>
                <div class="status-item" id="connection-status">
                    <span class="status-icon">‚≠ï</span>
                    <span class="status-text">Connect Handle</span>
                </div>
                <div class="status-item" id="charging-status">
                    <span class="status-icon">‚≠ï</span>
                    <span class="status-text">Start Charging</span>
                </div>
            </div>
        </div>

        <!-- Explosion Overlay -->
        <div class="explosion-overlay" id="explosion-overlay">
            <div class="explosion-animation">
                <div class="flame f1">üî•</div>
                <div class="flame f2">üí•</div>
                <div class="flame f3">üî•</div>
                <div class="flame f4">üí•</div>
                <div class="explosion-text">BATTERY OVERLOAD!</div>
            </div>
        </div>
    </div>

    <!-- Hidden Audio for Explosion -->
    <audio id="explosion-sound" preload="auto">
        <source src="res/aud/supercharger/Explosion.mp3" type="audio/mpeg">
    </audio>
    
    <script>
        // Game state
        let mathSolved = false;
        let carParked = false;
        let handleConnected = false;
        let charging = false;
        
        // Math Challenge Function
        function checkAnswer() {
            const answer = document.getElementById('math-answer').value;
            const correctAnswer = 68; // ‚à´(3x¬≤ + 2x - 5)dx from 0 to 4
            const feedback = document.getElementById('answer-feedback');
            
            if (parseInt(answer) === correctAnswer) {
                mathSolved = true;
                feedback.innerHTML = '<div class="correct-answer">‚úÖ Correct! Elite access granted.</div>';
                document.getElementById('elite-access').style.display = 'block';
            } else {
                feedback.innerHTML = '<div class="wrong-answer">‚ùå Incorrect. Hint: ‚à´(3x¬≤ + 2x - 5)dx = x¬≥ + x¬≤ - 5x</div>';
            }
        }
        
        function showEliteSection() {
            if (mathSolved) {
                document.querySelector('.elite-supercharger').classList.remove('hidden-section');
                document.querySelector('.math-challenge').style.display = 'none';
                
                // Show spinning cat when elite section opens
                document.querySelector('.spinning-cat').style.display = 'block';
                
                // Initialize drag and drop after showing elite section
                setTimeout(setupDragAndDrop, 100);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, setting up...');
        });
        
        function setupDragAndDrop() {
            console.log('Setting up drag and drop...');
            const teslaCar = document.getElementById('tesla-car');
            const parkingTarget = document.getElementById('parking-target');
            const chargingHandle = document.getElementById('charging-handle');
            const connectionTarget = document.getElementById('connection-target');
            
            if (!teslaCar || !parkingTarget || !chargingHandle || !connectionTarget) {
                console.log('Drag elements not found');
                setTimeout(setupDragAndDrop, 500); // Retry after 500ms
                return;
            }
            
            // Make elements draggable
            teslaCar.draggable = true;
            chargingHandle.draggable = true;
            
            // Tesla Car Drag Events
            teslaCar.addEventListener('dragstart', (e) => {
                console.log('Tesla drag start');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', 'tesla');
                setTimeout(() => teslaCar.classList.add('dragging'), 0);
            });
            
            teslaCar.addEventListener('dragend', (e) => {
                console.log('Tesla drag end');
                teslaCar.classList.remove('dragging');
            });
            
            // Parking Target Events
            parkingTarget.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                parkingTarget.classList.add('drag-over');
            });
            
            parkingTarget.addEventListener('dragenter', (e) => {
                e.preventDefault();
            });
            
            parkingTarget.addEventListener('dragleave', (e) => {
                // Only remove drag-over if we're actually leaving the element
                if (!parkingTarget.contains(e.relatedTarget)) {
                    parkingTarget.classList.remove('drag-over');
                }
            });
            
            parkingTarget.addEventListener('drop', (e) => {
                e.preventDefault();
                parkingTarget.classList.remove('drag-over');
                console.log('Drop event triggered on parking');
                
                const data = e.dataTransfer.getData('text/plain');
                console.log('Dropped data:', data);
                
                if (data === 'tesla') {
                    console.log('Tesla parked!');
                    parkTesla();
                }
            });
            
            // Charging Handle Events
            chargingHandle.addEventListener('dragstart', (e) => {
                if (!carParked) {
                    e.preventDefault();
                    showMessage('Park the Tesla first!');
                    return false;
                }
                console.log('Handle drag start');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', 'handle');
                setTimeout(() => chargingHandle.classList.add('dragging'), 0);
            });
            
            chargingHandle.addEventListener('dragend', (e) => {
                console.log('Handle drag end');
                chargingHandle.classList.remove('dragging');
            });
            
            // Connection Target Events
            connectionTarget.addEventListener('dragover', (e) => {
                if (carParked) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    connectionTarget.classList.add('drag-over');
                }
            });
            
            connectionTarget.addEventListener('dragenter', (e) => {
                if (carParked) {
                    e.preventDefault();
                }
            });
            
            connectionTarget.addEventListener('dragleave', (e) => {
                // Only remove drag-over if we're actually leaving the element
                if (!connectionTarget.contains(e.relatedTarget)) {
                    connectionTarget.classList.remove('drag-over');
                }
            });
            
            connectionTarget.addEventListener('drop', (e) => {
                e.preventDefault();
                connectionTarget.classList.remove('drag-over');
                console.log('Drop event triggered on connection zone');
                
                const data = e.dataTransfer.getData('text/plain');
                console.log('Dropped data:', data);
                
                if (data === 'handle' && carParked) {
                    console.log('Handle connected!');
                    connectHandle();
                }
            });
            
            console.log('Drag and drop setup complete');
        }
        
        function parkTesla() {
            carParked = true;
            document.getElementById('tesla-car').style.display = 'none';
            document.getElementById('parking-target').innerHTML = '<div class="parked-tesla">üöó Tesla Parked!</div>';
            document.getElementById('parking-status').innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">Tesla Parked</span>';
            checkProgress();
        }
        
        function connectHandle() {
            handleConnected = true;
            document.getElementById('charging-handle').style.display = 'none';
            document.getElementById('connection-target').innerHTML = '<div class="connected-handle">üîå Connected!</div>';
            document.getElementById('connection-status').innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">Handle Connected</span>';
            checkProgress();
        }
        
        function checkProgress() {
            const chargeButton = document.getElementById('charge-button');
            if (carParked && handleConnected) {
                chargeButton.disabled = false;
                chargeButton.innerHTML = '<span class="charge-text">üöÄ Start Elite Charging!</span>';
                chargeButton.classList.add('ready');
                chargeButton.onclick = startCharging;
            }
        }
        
        function startCharging() {
            if (!charging) {
                charging = true;
                document.getElementById('charging-status').innerHTML = '<span class="status-icon">‚ö°</span><span class="status-text">Charging Active</span>';
                document.getElementById('charge-button').innerHTML = '<span class="charge-text">‚ö° Charging... (Click to Stop)</span>';
                document.getElementById('charge-button').onclick = stopCharging;
                
                // Start charging effects
                document.querySelector('.fake-phone').classList.add('charging-active');
                document.querySelector('.power-level').style.width = '100%';
                
                // Make spinning cat go crazy during charging
                document.querySelector('.spinning-cat').classList.add('charging-spin');
                
                // Get current battery level or start at 32%
                let currentBatteryText = document.querySelector('.battery-percent').textContent;
                let batteryLevel = parseFloat(currentBatteryText.replace('%', '')) || 32;
                
                const batteryInterval = setInterval(() => {
                    if (!charging) {
                        clearInterval(batteryInterval);
                        return;
                    }
                    
                    batteryLevel += 0.8; // Faster charging
                    document.querySelector('.battery-fill').style.width = `${Math.min(batteryLevel, 110)}%`;
                    document.querySelector('.battery-percent').textContent = `${Math.round(batteryLevel)}%`;
                    
                    // Change battery color when overcharging
                    const batteryFill = document.querySelector('.battery-fill');
                    const batteryPercent = document.querySelector('.battery-percent');
                    
                    if (batteryLevel > 100) {
                        batteryFill.style.background = 'linear-gradient(90deg, #ff6b6b, #ff4757, #ff3838)';
                        batteryPercent.style.color = '#ff4757';
                        batteryPercent.style.fontWeight = 'bold';
                        batteryPercent.style.textShadow = '0 0 10px #ff4757';
                        
                        // Add danger warning
                        document.getElementById('charging-status').innerHTML = '<span class="status-icon">‚ö†Ô∏è</span><span class="status-text">OVERCHARGING!</span>';
                    }
                    
                    // Trigger explosion at 110%
                    if (batteryLevel >= 110) {
                        triggerOverchargeExplosion();
                        clearInterval(batteryInterval);
                        return;
                    }
                }, 150);
                
                // Store interval for stopping
                window.currentBatteryInterval = batteryInterval;
                
                // Animate cost and bank deduction
                let cost = 0;
                let bankBalance = parseFloat(document.querySelector('.balance-amount').textContent.replace('$', '').replace('-', '').replace(',', '')) || 50000;
                
                const costInterval = setInterval(() => {
                    if (!charging) {
                        clearInterval(costInterval);
                        return;
                    }
                    cost += 2.50;
                    bankBalance -= 2.50;
                    document.querySelector('.total-cost').textContent = `Total: $${cost.toFixed(2)}`;
                    document.querySelector('.transaction-amount').textContent = `-$${cost.toFixed(2)}`;
                    document.querySelector('.balance-amount').textContent = `$${bankBalance.toFixed(2)}`;
                    
                    // Change color as money decreases
                    if (bankBalance < 40000) {
                        document.querySelector('.balance-amount').style.color = '#f39c12';
                    }
                    if (bankBalance < 30000) {
                        document.querySelector('.balance-amount').style.color = '#e74c3c';
                    }
                }, 1000);
                
                // Store interval for stopping
                window.currentCostInterval = costInterval;
            }
        }
        
        function stopCharging() {
            charging = false;
            document.getElementById('charging-status').innerHTML = '<span class="status-icon">‚≠ï</span><span class="status-text">Stopped</span>';
            document.getElementById('charge-button').innerHTML = '<span class="charge-text">üöÄ Start Elite Charging!</span>';
            document.getElementById('charge-button').onclick = startCharging;
            document.querySelector('.fake-phone').classList.remove('charging-active');
            document.querySelector('.power-level').style.width = '0%';
            
            // Clear intervals
            if (window.currentBatteryInterval) {
                clearInterval(window.currentBatteryInterval);
            }
            if (window.currentCostInterval) {
                clearInterval(window.currentCostInterval);
            }
            
            // Keep current battery level when stopping
            const currentBattery = document.querySelector('.battery-percent').textContent;
            console.log('Stopped charging at battery level:', currentBattery);
            
            // Reset battery color if it was overcharging
            const batteryLevel = parseFloat(currentBattery.replace('%', ''));
            if (batteryLevel > 100) {
                document.querySelector('.battery-fill').style.background = 'linear-gradient(90deg, #e74c3c, #f39c12, #27ae60)';
                document.querySelector('.battery-percent').style.color = '#f39c12';
                document.querySelector('.battery-percent').style.textShadow = 'none';
            }
            
            // Return cat to normal spinning
            document.querySelector('.spinning-cat').classList.remove('charging-spin');
        }
        
        function triggerGiantExplosion() {
            charging = false;
            document.body.classList.add('giant-explosion-active');
            document.getElementById('explosion-overlay').style.display = 'flex';
            document.getElementById('explosion-overlay').classList.add('giant-explosion');
            document.getElementById('charging-status').innerHTML = '<span class="status-icon">üí•</span><span class="status-text">MASSIVE EXPLOSION!</span>';
            
            // Make cat spin wildly during explosion
            document.querySelector('.spinning-cat').classList.add('explosion-spin');
            
            // Create flying Tesla
            createFlyingTesla();
            
            // Deduct massive money
            const lostAmount = (Math.random() * 25000 + 20000).toFixed(2);
            document.querySelector('.balance-amount').textContent = `-$${lostAmount}`;
            document.querySelector('.balance-amount').style.color = '#ff0000';
            document.querySelector('.balance-amount').style.fontSize = '1.5rem';
            document.querySelector('.balance-amount').style.textShadow = '0 0 10px #ff0000';
            
            // Reset parked state - Tesla is now flying around
            carParked = false;
            handleConnected = false;
            document.getElementById('parking-status').innerHTML = '<span class="status-icon">üí•</span><span class="status-text">Tesla Escaped!</span>';
            document.getElementById('connection-status').innerHTML = '<span class="status-icon">‚≠ï</span><span class="status-text">Connect Handle</span>';
            
            // Play explosion sound multiple times
            const audio = document.getElementById('explosion-sound');
            if (audio) {
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        audio.currentTime = 0;
                        audio.play().catch(() => {});
                    }, i * 500);
                }
            }
            
            // Screen shake effect
            document.body.classList.add('screen-shake');
            
            setTimeout(() => {
                document.body.classList.remove('giant-explosion-active');
                document.body.classList.remove('screen-shake');
                document.getElementById('explosion-overlay').style.display = 'none';
                document.getElementById('explosion-overlay').classList.remove('giant-explosion');
                document.querySelector('.spinning-cat').classList.remove('explosion-spin');
                
                // Reset the game after explosion
                resetGameAfterExplosion();
            }, 6000);
        }
        
        function createFlyingTesla() {
            // Create a flying Tesla element
            const flyingTesla = document.createElement('div');
            flyingTesla.className = 'flying-tesla';
            flyingTesla.innerHTML = 'üöó';
            document.body.appendChild(flyingTesla);
            
            // Animate the Tesla flying around
            let angle = 0;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const radius = 200;
            
            const flyInterval = setInterval(() => {
                angle += 0.2;
                const x = centerX + Math.cos(angle) * radius + (Math.random() - 0.5) * 100;
                const y = centerY + Math.sin(angle) * radius + (Math.random() - 0.5) * 100;
                
                flyingTesla.style.left = `${x}px`;
                flyingTesla.style.top = `${y}px`;
                flyingTesla.style.transform = `rotate(${angle * 180 / Math.PI}deg) scale(${1 + Math.sin(angle * 2) * 0.3})`;
            }, 50);
            
            setTimeout(() => {
                clearInterval(flyInterval);
                if (flyingTesla.parentNode) {
                    flyingTesla.remove();
                }
            }, 6000);
        }
        
        function startTeslaWhippingPhase() {
            console.log('Starting Tesla whipping phase for 1 minute...');
            
            // Update status to show whipping phase
            document.getElementById('charging-status').innerHTML = '<span class="status-icon">üåÄ</span><span class="status-text">Tesla Whipping Around!</span>';
            
            // Disable all interactions during whipping
            document.getElementById('charge-button').disabled = true;
            document.getElementById('charge-button').innerHTML = '<span class="charge-text">Tesla is Whipping Around...</span>';
            document.getElementById('unpark-button').disabled = true;
            document.getElementById('unpark-button').style.opacity = '0.5';
            
            // Create multiple whipping Teslas
            const whippingTeslas = [];
            const numTeslas = 3;
            
            for (let i = 0; i < numTeslas; i++) {
                const whippingTesla = document.createElement('div');
                whippingTesla.className = 'whipping-tesla';
                whippingTesla.innerHTML = 'üöó';
                whippingTesla.style.zIndex = '9998';
                document.body.appendChild(whippingTesla);
                whippingTeslas.push({
                    element: whippingTesla,
                    angle: i * (Math.PI * 2 / numTeslas),
                    speed: 0.3 + Math.random() * 0.2,
                    radius: 150 + i * 50,
                    centerX: window.innerWidth / 2,
                    centerY: window.innerHeight / 2
                });
            }
            
            // Animate whipping Teslas
            const whipInterval = setInterval(() => {
                whippingTeslas.forEach((tesla, index) => {
                    tesla.angle += tesla.speed;
                    
                    // Add chaotic movement
                    const chaosX = Math.sin(tesla.angle * 3) * 100;
                    const chaosY = Math.cos(tesla.angle * 2) * 80;
                    
                    const x = tesla.centerX + Math.cos(tesla.angle) * tesla.radius + chaosX;
                    const y = tesla.centerY + Math.sin(tesla.angle) * tesla.radius + chaosY;
                    
                    // Keep within screen bounds with bouncing
                    const boundedX = Math.max(50, Math.min(window.innerWidth - 50, x));
                    const boundedY = Math.max(50, Math.min(window.innerHeight - 50, y));
                    
                    tesla.element.style.left = `${boundedX}px`;
                    tesla.element.style.top = `${boundedY}px`;
                    tesla.element.style.transform = `rotate(${tesla.angle * 180 / Math.PI}deg) scale(${2 + Math.sin(tesla.angle * 4) * 0.5})`;
                    
                    // Change color periodically
                    if (Math.floor(tesla.angle * 10) % 20 === 0) {
                        tesla.element.style.filter = `hue-rotate(${tesla.angle * 100}deg) saturate(2)`;
                    }
                });
            }, 30);
            
            // Add countdown timer
            let timeLeft = 60;
            document.getElementById('charge-button').innerHTML = `<span class="charge-text">Tesla Whipping: ${timeLeft}s</span>`;
            
            const countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('charge-button').innerHTML = `<span class="charge-text">Tesla Whipping: ${timeLeft}s</span>`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            // End whipping phase after 1 minute
            setTimeout(() => {
                console.log('Ending Tesla whipping phase...');
                clearInterval(whipInterval);
                clearInterval(countdownInterval);
                
                // Remove all whipping Teslas
                whippingTeslas.forEach(tesla => {
                    if (tesla.element.parentNode) {
                        tesla.element.remove();
                    }
                });
                
                // Re-enable interactions
                document.getElementById('unpark-button').disabled = false;
                document.getElementById('unpark-button').style.opacity = '1';
                
                // Reset the game to normal state
                resetGameAfterExplosion();
                
                // Show completion message
                document.getElementById('charging-status').innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">Tesla Calmed Down!</span>';
                
                setTimeout(() => {
                    document.getElementById('charging-status').innerHTML = '<span class="status-icon">‚≠ï</span><span class="status-text">Start Charging</span>';
                }, 3000);
                
            }, 60000); // 60 seconds
        }
        
        function unparkCar() {
            if (carParked) {
                // Stop charging if active
                if (charging) {
                    stopCharging();
                }
                
                // Reset car state
                carParked = false;
                handleConnected = false;
                
                // Reset parking target
                document.getElementById('parking-target').innerHTML = '<div class="parking-lines"></div><div class="drop-instruction">Drop Tesla Here</div>';
                document.getElementById('parking-target').classList.remove('car-parked');
                
                // Reset connection target
                document.getElementById('connection-target').innerHTML = '<div class="connection-instruction">Connection Zone</div>';
                document.getElementById('connection-target').classList.remove('handle-connected');
                
                // Show Tesla and handle again
                document.getElementById('tesla-car').style.display = 'flex';
                document.getElementById('charging-handle').style.display = 'flex';
                
                // Reset status indicators
                document.getElementById('parking-status').innerHTML = '<span class="status-icon">‚≠ï</span><span class="status-text">Park Tesla</span>';
                document.getElementById('connection-status').innerHTML = '<span class="status-icon">‚≠ï</span><span class="status-text">Connect Handle</span>';
                
                // Reset button
                const chargeButton = document.getElementById('charge-button');
                chargeButton.disabled = true;
                chargeButton.innerHTML = '<span class="charge-text">Complete Setup First</span>';
                chargeButton.classList.remove('ready');
                
                // Reset power display
                document.querySelector('.power-level').style.width = '0%';
                
                console.log('Car unparked successfully');
            }
        }
        
        function resetGameAfterExplosion() {
            console.log('Resetting game after explosion...');
            
            // Reset game state variables
            carParked = false;
            handleConnected = false;
            charging = false;
            
            // Reset parking target
            document.getElementById('parking-target').innerHTML = '<div class="parking-lines"></div><div class="drop-instruction">Drop Tesla Here</div>';
            document.getElementById('parking-target').classList.remove('car-parked');
            
            // Reset connection target
            document.getElementById('connection-target').innerHTML = '<div class="connection-instruction">Connection Zone</div>';
            document.getElementById('connection-target').classList.remove('handle-connected');
            
            // Show Tesla and handle again
            document.getElementById('tesla-car').style.display = 'flex';
            document.getElementById('charging-handle').style.display = 'flex';
            
            // Reset status indicators
            document.getElementById('parking-status').innerHTML = '<span class="status-icon">‚≠ï</span><span class="status-text">Park Tesla</span>';
            document.getElementById('connection-status').innerHTML = '<span class="status-icon">‚≠ï</span><span class="status-text">Connect Handle</span>';
            
            // Reset button
            const chargeButton = document.getElementById('charge-button');
            chargeButton.disabled = true;
            chargeButton.innerHTML = '<span class="charge-text">Complete Setup First</span>';
            chargeButton.classList.remove('ready');
            chargeButton.onclick = null;
            
            // Reset power and battery displays
            document.querySelector('.power-level').style.width = '0%';
            document.querySelector('.battery-fill').style.width = '32%';
            document.querySelector('.battery-percent').textContent = '32%';
            
            // Reset battery colors
            document.querySelector('.battery-fill').style.background = 'linear-gradient(90deg, #e74c3c, #f39c12, #27ae60)';
            document.querySelector('.battery-percent').style.color = '#f39c12';
            document.querySelector('.battery-percent').style.textShadow = 'none';
            document.querySelector('.battery-percent').style.fontWeight = 'bold';
            
            // Reset cost display
            document.querySelector('.total-cost').textContent = 'Total: $0.00';
            document.querySelector('.transaction-amount').textContent = '-$0.00';
            
            // Re-setup drag and drop
            setTimeout(() => {
                setupDragAndDrop();
            }, 500);
        }
        
        function triggerOverchargeExplosion() {
            charging = false;
            
            // Clear any running intervals
            if (window.currentBatteryInterval) {
                clearInterval(window.currentBatteryInterval);
            }
            if (window.currentCostInterval) {
                clearInterval(window.currentCostInterval);
            }
            
            document.body.classList.add('overcharge-explosion-active');
            document.getElementById('explosion-overlay').style.display = 'flex';
            document.getElementById('explosion-overlay').classList.add('overcharge-explosion');
            
            // Update explosion text for overcharge
            document.querySelector('.explosion-text').textContent = 'BATTERY OVERCHARGE EXPLOSION!';
            document.getElementById('charging-status').innerHTML = '<span class="status-icon">üí•</span><span class="status-text">OVERCHARGED!</span>';
            
            // Make cat spin wildly during explosion
            document.querySelector('.spinning-cat').classList.add('explosion-spin');
            
            // Create flying Tesla
            createFlyingTesla();
            
            // Deduct massive money for overcharge
            const lostAmount = (Math.random() * 35000 + 30000).toFixed(2);
            document.querySelector('.balance-amount').textContent = `-$${lostAmount}`;
            document.querySelector('.balance-amount').style.color = '#ff0000';
            document.querySelector('.balance-amount').style.fontSize = '1.5rem';
            document.querySelector('.balance-amount').style.textShadow = '0 0 10px #ff0000';
            
            // Reset parked state
            carParked = false;
            handleConnected = false;
            document.getElementById('parking-status').innerHTML = '<span class="status-icon">üí•</span><span class="status-text">Tesla Escaped!</span>';
            document.getElementById('connection-status').innerHTML = '<span class="status-icon">‚≠ï</span><span class="status-text">Connect Handle</span>';
            
            // Play explosion sound multiple times
            const audio = document.getElementById('explosion-sound');
            if (audio) {
                for (let i = 0; i < 4; i++) {
                    setTimeout(() => {
                        audio.currentTime = 0;
                        audio.play().catch(() => {});
                    }, i * 400);
                }
            }
            
            // Screen shake effect
            document.body.classList.add('screen-shake');
            
            setTimeout(() => {
                document.body.classList.remove('overcharge-explosion-active');
                document.body.classList.remove('screen-shake');
                document.getElementById('explosion-overlay').style.display = 'none';
                document.getElementById('explosion-overlay').classList.remove('overcharge-explosion');
                document.querySelector('.spinning-cat').classList.remove('explosion-spin');
                
                // Reset explosion text
                document.querySelector('.explosion-text').textContent = 'BATTERY OVERLOAD!';
                
                // Start 1-minute Tesla whipping phase
                startTeslaWhippingPhase();
            }, 7000);
        }
        
        function triggerExplosion() {
            // Legacy function - redirect to giant explosion
            triggerGiantExplosion();
        }
        
        function showMessage(text) {
            const feedback = document.getElementById('answer-feedback');
            feedback.innerHTML = `<div class="info-message">${text}</div>`;
            setTimeout(() => {
                feedback.innerHTML = '';
            }, 3000);
        }
    </script>
</body>
</html>